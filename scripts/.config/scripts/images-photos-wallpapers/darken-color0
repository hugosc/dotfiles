#!/usr/bin/env python3
"""Darken all colors in wal's color files uniformly to reduce harshness."""

import colorsys
import json
import re
import sys
from pathlib import Path


def hex_to_hsl(hex_color):
    """Convert hex color to HSL."""
    hex_color = hex_color.lstrip("#")
    r, g, b = tuple(int(hex_color[i : i + 2], 16) / 255.0 for i in (0, 2, 4))
    h, l, s = colorsys.rgb_to_hls(r, g, b)
    return h, l, s


def hsl_to_hex(h, l, s):
    """Convert HSL to hex color."""
    r, g, b = colorsys.hls_to_rgb(h, l, s)
    return "#{:02x}{:02x}{:02x}".format(int(r * 255), int(g * 255), int(b * 255))


def darken_color(color_hex, lightness_reduction=0.20):
    """Darken a color by reducing lightness uniformly."""
    h, l, s = hex_to_hsl(color_hex)
    # Reduce lightness uniformly, maintaining saturation and hue
    new_l = max(0.0, l - lightness_reduction)
    return hsl_to_hex(h, new_l, s)


def enrich_color0(color_hex, lightness_reduction=0.30, saturation_increase=0.0):
    """Darken a color AND add subtle saturation for richness (used for color0/background)."""
    h, l, s = hex_to_hsl(color_hex)
    # Reduce lightness uniformly
    new_l = max(0.0, l - lightness_reduction)
    # Add a tiny bit of saturation for subtle warmth
    new_s = min(0.8, s + saturation_increase)
    return hsl_to_hex(h, new_l, new_s)


def process_sequences_file(sequences_file_path, darkened_colors_map):
    """Update all colors in the sequences file."""
    try:
        with open(sequences_file_path, "r") as f:
            content = f.read()

        # Replace background colors (]11 and ]708)
        for old_color, new_color in darkened_colors_map.items():
            pattern = re.escape(old_color)
            content = re.sub(pattern, new_color, content, flags=re.IGNORECASE)

        with open(sequences_file_path, "w") as f:
            f.write(content)

        return True
    except Exception as e:
        print(f"Error processing {sequences_file_path}: {e}", file=sys.stderr)
        return False


def process_xresources_file(xresources_file_path, darkened_colors_map):
    """Update all colors in the Xresources file."""
    try:
        with open(xresources_file_path, "r") as f:
            content = f.read()

        for old_color, new_color in darkened_colors_map.items():
            pattern = re.escape(old_color)
            content = re.sub(pattern, new_color, content, flags=re.IGNORECASE)

        with open(xresources_file_path, "w") as f:
            f.write(content)

        return True
    except Exception as e:
        print(f"Error processing {xresources_file_path}: {e}", file=sys.stderr)
        return False


def process_vim_colors_file(vim_colors_file_path, darkened_colors_map):
    """Update all colors in the vim colors file for Neovim."""
    try:
        with open(vim_colors_file_path, "r") as f:
            content = f.read()

        for old_color, new_color in darkened_colors_map.items():
            pattern = re.escape(old_color)
            content = re.sub(pattern, new_color, content, flags=re.IGNORECASE)

        with open(vim_colors_file_path, "w") as f:
            f.write(content)

        return True
    except Exception as e:
        print(f"Error processing {vim_colors_file_path}: {e}", file=sys.stderr)
        return False


def regenerate_kitty_config(colors_json_path, kitty_config_path):
    """Regenerate colors-kitty.conf from darkened colors.json"""
    try:
        with open(colors_json_path, "r") as f:
            data = json.load(f)

        special = data.get("special", {})
        colors = data.get("colors", {})

        # Build kitty config with the darkened colors
        config_content = f"""foreground   {special.get("foreground", "#ffffff")}
background   {special.get("background", "#000000")}
cursor       {special.get("cursor", "#ffffff")}

color0       {colors.get("color0", "#000000")}
color8       {colors.get("color8", "#808080")}
color1       {colors.get("color1", "#ff0000")}
color9       {colors.get("color9", "#ff0000")}
color2       {colors.get("color2", "#00ff00")}
color10      {colors.get("color10", "#00ff00")}
color3       {colors.get("color3", "#ffff00")}
color11      {colors.get("color11", "#ffff00")}
color4       {colors.get("color4", "#0000ff")}
color12      {colors.get("color12", "#0000ff")}
color5       {colors.get("color5", "#ff00ff")}
color13      {colors.get("color13", "#ff00ff")}
color6       {colors.get("color6", "#00ffff")}
color14      {colors.get("color14", "#00ffff")}
color7       {colors.get("color7", "#ffffff")}
color15      {colors.get("color15", "#ffffff")}
"""

        with open(kitty_config_path, "w") as f:
            f.write(config_content)

        return True
    except Exception as e:
        print(f"Error regenerating kitty config: {e}", file=sys.stderr)
        return False


def main():
    # wal color file locations
    cache_dir = Path.home() / ".cache" / "wal"
    colors_file = cache_dir / "colors"
    colors_json_file = cache_dir / "colors.json"
    sequences_file = cache_dir / "sequences"
    xresources_file = cache_dir / "colors.Xresources"
    vim_colors_file = cache_dir / "colors-wal.vim"

    lightness_reduction = float(sys.argv[1]) if len(sys.argv) > 1 else 0.20
    saturation_increase = float(sys.argv[2]) if len(sys.argv) > 2 else 0.10

    success = True
    darkened_colors_map = {}

    # Process colors.json to darken all colors (and enrich color0 with saturation)
    if colors_json_file.exists():
        try:
            with open(colors_json_file, "r") as f:
                data = json.load(f)

            modified = False

            # Darken all colors in the colors dict, but enrich color0 specifically
            if "colors" in data:
                for key in data["colors"]:
                    original_color = data["colors"][key]
                    # Special handling for color0: add saturation alongside darkening
                    if key == "color0":
                        darkened_color = enrich_color0(
                            original_color, lightness_reduction, saturation_increase
                        )
                    else:
                        darkened_color = darken_color(
                            original_color, lightness_reduction
                        )
                    darkened_colors_map[original_color] = darkened_color
                    data["colors"][key] = darkened_color
                    modified = True

            # Darken special colors (background, foreground, cursor)
            if "special" in data:
                for key in data["special"]:
                    original_color = data["special"][key]
                    # Special handling for background: add saturation alongside darkening
                    if key == "background":
                        darkened_color = enrich_color0(
                            original_color, lightness_reduction, saturation_increase
                        )
                    else:
                        darkened_color = darken_color(
                            original_color, lightness_reduction
                        )
                    darkened_colors_map[original_color] = darkened_color
                    data["special"][key] = darkened_color
                    modified = True

            if modified:
                with open(colors_json_file, "w") as f:
                    json.dump(data, f, indent=2)
        except Exception as e:
            print(f"Error processing {colors_json_file}: {e}", file=sys.stderr)
            success = False

    # Update other files with the color mapping
    if darkened_colors_map:
        # Update sequences file
        if sequences_file.exists():
            success &= process_sequences_file(sequences_file, darkened_colors_map)

        # Update Xresources file
        if xresources_file.exists():
            success &= process_xresources_file(xresources_file, darkened_colors_map)

        # Update vim colors file
        if vim_colors_file.exists():
            success &= process_vim_colors_file(vim_colors_file, darkened_colors_map)

    # Regenerate kitty config from the darkened colors.json
    kitty_config_file = cache_dir / "colors-kitty.conf"
    success &= regenerate_kitty_config(colors_json_file, kitty_config_file)

    return 0 if success else 1


if __name__ == "__main__":
    sys.exit(main())
