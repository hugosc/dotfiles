#!/usr/bin/env bash
export DISPLAY=:0

# st is hardcoded, but you can
# switch to another terminal
# and adjust parameters as needed

# uses fzfub wallpaper picker with some extra options
# first arg is wallpaper selection
# second arg is optional theme or mode (dark/light)

WPFOLDER=~/Pictures/wallpaper/ # wallpaper folder
PW16SCRIPT=~/scripts/pywal16 # pywal16 post-run script
TEMPIMG=~/Pictures/wallpaper/temp # save as a temporary image for restoration on restart

case "$#" in
	0) 
		# Reload pywal colors into xrdb before launching menu
		[ -f ~/.cache/wal/colors.Xresources ] && xrdb -merge ~/.cache/wal/colors.Xresources
		[ -f ~/.cache/wal/xrdb_extra ] && xrdb -merge ~/.cache/wal/xrdb_extra
		[ -f ~/.cache/wal/st ] && xrdb -merge ~/.cache/wal/st
		# Source and export FZF colors
		[ -f ~/.cache/wal/colors.sh ] && . ~/.cache/wal/colors.sh && export FZF_DEFAULT_OPTS
		# Launch st and apply sequences immediately, then run fzfub
		st -f 'Liberation Mono:pixelsize=14' -c fzfmenu -n fzfmenu -T fzf -g "160x25+0+0" -e sh -c 'cat ~/.cache/wal/sequences 2>/dev/null; exec fzfub '"$WPFOLDER"' w' || exit 0 
		;;
	1) wal -i "$1" -o "$PW16SCRIPT" && ln -sf "$1" "$TEMPIMG" > /dev/null 2>&1 ;;
	2) 
		# Handle both theme and dark/light mode
		if [[ "$2" == "light" ]]; then
			# Generate light colors, darken them, regenerate templates from darkened colors, then run post-scripts
			wal -i "$1" -l && \
			~/dotfiles/scripts/.config/scripts/images-photos-wallpapers/darken-color0 && \
			~/dotfiles/scripts/.config/scripts/images-photos-wallpapers/regenerate-wal-templates && \
			ln -sf "$1" "$TEMPIMG" > /dev/null 2>&1
			nohup "$PW16SCRIPT" >/dev/null 2>&1 &
		elif [[ "$2" == "dark" ]]; then
			wal -i "$1" -o "$PW16SCRIPT" && ln -sf "$1" "$TEMPIMG" > /dev/null 2>&1
		else
			# Assume it's a theme name
			wal -i "$1" --theme "$2" -o "$PW16SCRIPT" && ln -sf "$1" "$TEMPIMG" > /dev/null 2>&1
		fi
		;;
	*) exit 0 ;;
esac
