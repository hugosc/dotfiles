#!/bin/bash
# Script to refresh DWM colors after wal generates new colorscheme

export DISPLAY=${DISPLAY:-:0}

ln -sf ~/.cache/wal/colors.Xresources ~/.Xresources

# Combine all Xresources into one file and load with single command
# This is more reliable than merge according to historical behavior
cat ~/.cache/wal/colors.Xresources > /tmp/xresources_combined.tmp
[[ -f ~/.cache/wal/xrdb_extra ]] && cat ~/.cache/wal/xrdb_extra >> /tmp/xresources_combined.tmp
[[ -f ~/.cache/wal/dmenu ]] && cat ~/.cache/wal/dmenu >> /tmp/xresources_combined.tmp

# Load everything at once - historically this has worked better than merge
xrdb -load /tmp/xresources_combined.tmp

# Trigger DWM xrdb reload via keybind (Super+Ctrl+Backslash)
xdotool key super+ctrl+backslash

# Refresh dwmblocks status bar (block 8 for color/theme updates)
pkill -RTMIN+8 dwmblocks 2>/dev/null || true

# Apply terminal color sequences to all running st terminals
if [[ -f ~/.cache/wal/sequences ]]; then
    for tty in /dev/pts/*; do
        if [[ -w "$tty" ]]; then
            cat ~/.cache/wal/sequences > "$tty" 2>/dev/null &
        fi
    done
    wait
fi

# Reload kitty on all running instances
if command -v kitty &> /dev/null; then
    kitty @ set-colors --all ~/.cache/wal/colors-kitty.conf 2>/dev/null || true
fi

# Update dunst colors
if [[ -f ~/.cache/wal/dunstrc ]]; then
    cp ~/.cache/wal/dunstrc ~/.config/dunst/dunstrc
    pkill -HUP dunst 2>/dev/null || true
fi
